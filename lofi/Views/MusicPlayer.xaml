<UserControl x:Class="lofi.Views.MusicPlayer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:b="clr-namespace:lofi.Behavior"
             b:DragInCanvasBehavior.IsEnabled="True"
             b:DragInCanvasBehavior.BringToFront="True"
             b:DragInCanvasBehavior.ClampToParent="True"
             Width="260" MinWidth="260">

    <!-- Height 지정 X → 콘텐츠에 맞춰 자동, 잘림 방지 -->
    <Grid x:Name="Root" Background="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="30"/>
            <!-- 헤더 살짝 키움 -->
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 카드 배경 -->
        <Border Grid.RowSpan="2"
                Style="{StaticResource Card.Container}"
                IsHitTestVisible="False"
                Panel.ZIndex="0"/>

        <!-- 헤더(드래그 그립 + 중앙 타이틀) -->
        <Grid Grid.Row="0"
              Background="#10000000"
              Cursor="SizeAll"
              b:DragInCanvasBehavior.IsDragGrip="True"
              Panel.ZIndex="5">
            <TextBlock Text="Music Player"
                       VerticalAlignment="Center"
                       HorizontalAlignment="Center">
                <TextBlock.Style>
                    <!-- ★ 전역 폰트 확실히 적용: App.TextBlockBase를 BasedOn -->
                    <Style TargetType="TextBlock" BasedOn="{StaticResource App.TextBlockBase}">
                        <Setter Property="FontWeight" Value="SemiBold"/>
                        <Setter Property="FontSize"   Value="13"/>
                        <Setter Property="Foreground" Value="#2E3440"/>
                        <!-- 라이트 -->
                        <Style.Triggers>
                            <DataTrigger
                                Binding="{Binding DataContext.TodoListViewModel.TextColor.Color,
                                                  RelativeSource={RelativeSource AncestorType=Window}}"
                                Value="#FFFFFFFF">
                                <Setter Property="Foreground" Value="{StaticResource Dark.Text}"/>
                                <!-- 다크 -->
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>
        </Grid>

        <!-- 본문 -->
        <Grid Grid.Row="1" Margin="12,10,12,12" Panel.ZIndex="10">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <!-- 커버 -->
                <RowDefinition Height="10"/>
                <RowDefinition Height="Auto"/>
                <!-- 제목 -->
                <RowDefinition Height="8"/>
                <RowDefinition Height="Auto"/>
                <!-- 슬라이더 -->
                <RowDefinition Height="6"/>
                <!-- 시간 -->
                <RowDefinition Height="10"/>
                <RowDefinition Height="Auto"/>
                <!-- 버튼 -->
            </Grid.RowDefinitions>

            <!-- 커버 (조금 키움) -->
            <Grid Grid.Row="0" Width="130" Height="130" HorizontalAlignment="Center" Margin="0,10,0,0">
                <Rectangle RadiusX="12" RadiusY="12" Fill="#112E3440"/>
                <Rectangle RadiusX="12" RadiusY="12">
                    <Rectangle.Fill>
                        <ImageBrush ImageSource="{Binding CoverImage}" Stretch="UniformToFill"/>
                    </Rectangle.Fill>
                    <Rectangle.Style>
                        <Style TargetType="Rectangle">
                            <Setter Property="Opacity" Value="1"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding CoverImage}" Value="{x:Null}">
                                    <Setter Property="Opacity" Value="0"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Rectangle.Style>
                </Rectangle>
            </Grid>

            <!-- 트랙 제목 -->
            <TextBlock Grid.Row="2"
                       Style="{StaticResource Text.MusicPlayer.Title}"
                       Text="{Binding TrackTitle}"
                       TextTrimming="CharacterEllipsis"
                       HorizontalAlignment="Center"
                       FontSize="14"
                       MaxWidth="186"/>

            <!-- 진행 바 -->
            <Slider Grid.Row="4"
                    Style="{StaticResource Slider.Mini}"
                    Minimum="0"
                    Maximum="{Binding DurationSeconds}"
                    Value="{Binding PositionSeconds, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    IsMoveToPointEnabled="True"
                    Height="22"
                    PreviewMouseDown="Slider_PreviewMouseDown"
                    PreviewMouseUp="Slider_PreviewMouseUp"/>

            <!-- 시간 표시 -->
            <Grid Grid.Row="6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0"
                           Style="{StaticResource Text.MusicPlayer.Time}"
                           Text="{Binding PositionText}"
                           HorizontalAlignment="Left"/>
                <TextBlock Grid.Column="1"
                           Style="{StaticResource Text.MusicPlayer.Time}"
                           Text="{Binding DurationText}"
                           HorizontalAlignment="Right"/>
            </Grid>

            <!-- 컨트롤 버튼 -->
            <Grid Grid.Row="8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition/>
                </Grid.ColumnDefinitions>

                <!-- Prev -->
                <Button Grid.Column="0"
                        Width="30" Height="30"
                        HorizontalAlignment="Right"
                        Style="{StaticResource Button.Icon.Ghost}"
                        Command="{Binding PrevCommand}">
                    <Image Width="25" Height="25" Style="{StaticResource Img.Prev.Theme}"/>
                </Button>

                <!-- Play/Pause -->
                <Button Grid.Column="1"
                        Width="36" Height="36"
                        Margin="10,0"
                        Style="{StaticResource Button.Icon.Ghost}"
                        Command="{Binding PlayPauseCommand}">
                    <Grid>
                        <!-- Play -->
                        <Image Width="35" Height="35">
                            <Image.Style>
                                <Style TargetType="Image" BasedOn="{StaticResource Img.Play.Theme}">
                                    <Setter Property="Visibility" Value="Visible"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                        <!-- Pause -->
                        <Image Width="24" Height="24">
                            <Image.Style>
                                <Style TargetType="Image" BasedOn="{StaticResource Img.Pause.Theme}">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsPlaying}" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Image.Style>
                        </Image>
                    </Grid>
                </Button>

                <!-- Next -->
                <Button Grid.Column="2"
                        Width="30" Height="30"
                        HorizontalAlignment="Left"
                        Style="{StaticResource Button.Icon.Ghost}"
                        Command="{Binding NextCommand}">
                    <Image Width="25" Height="25" Style="{StaticResource Img.Next.Theme}"/>
                </Button>
            </Grid>
        </Grid>
    </Grid>
</UserControl>
